<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4a90d9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CO2 Monitor</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            padding: 16px;
            padding-bottom: env(safe-area-inset-bottom, 16px);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* 标题栏 */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a90d9;
        }

        .header .subtitle {
            font-size: 0.875rem;
            color: #888;
            margin-top: 4px;
        }

        /* 主数值显示区 */
        .main-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .co2-value {
            font-size: 5rem;
            font-weight: 700;
            line-height: 1;
            transition: color 0.3s ease;
        }

        .co2-unit {
            font-size: 1.5rem;
            color: #888;
            margin-left: 8px;
        }

        /* 空气质量状态卡片 */
        .status-card {
            background-color: #252542;
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-text {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .status-desc {
            font-size: 0.875rem;
            color: #888;
            margin-top: 2px;
        }

        /* 统计栏 */
        .stats-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            flex: 1;
            background-color: #252542;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 4px;
        }

        /* 图表区 */
        .chart-container {
            background-color: #252542;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            height: 200px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* 操作按钮 */
        .button-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #4a90d9;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a7fc8;
        }

        .btn-primary:disabled {
            background-color: #3a5a7a;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #3a3a5a;
            color: #ccc;
        }

        .btn-secondary:hover {
            background-color: #4a4a6a;
        }

        .btn-danger {
            background-color: #5a2a2a;
            color: #ff8888;
        }

        .btn-danger:hover {
            background-color: #6a3a3a;
        }

        .btn.connected {
            background-color: #2a5a3a;
            color: #88ff88;
        }

        /* 状态栏 */
        .status-bar {
            text-align: center;
            font-size: 0.875rem;
            color: #666;
        }

        .status-bar .record-count {
            color: #4a90d9;
        }

        /* 颜色定义 */
        .color-good { color: #00c853; }
        .color-moderate { color: #ffc107; }
        .color-bad { color: #ff5252; }

        .bg-good { background-color: #00c853; }
        .bg-moderate { background-color: #ffc107; }
        .bg-bad { background-color: #ff5252; }

        /* 响应式 - 小屏幕 */
        @media (max-width: 359px) {
            body {
                padding: 12px;
            }
            .co2-value {
                font-size: 3.5rem;
            }
            .stat-value {
                font-size: 1.25rem;
            }
            .btn {
                padding: 12px;
                font-size: 0.875rem;
            }
        }

        /* 响应式 - 大屏幕 */
        @media (min-width: 601px) {
            .co2-value {
                font-size: 6rem;
            }
            .chart-container {
                height: 250px;
            }
        }

        /* 连接状态动画 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connecting {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标题栏 -->
        <div class="header">
            <h1>CO2 便携监测器</h1>
            <div class="subtitle" id="connectionStatus">未连接设备</div>
        </div>

        <!-- 主数值显示区 -->
        <div class="main-display">
            <span class="co2-value color-good" id="co2Value">---</span>
            <span class="co2-unit">ppm</span>
        </div>

        <!-- 空气质量状态卡片 -->
        <div class="status-card">
            <div class="status-indicator bg-good" id="statusIndicator"></div>
            <div>
                <div class="status-text" id="statusText">等待连接</div>
                <div class="status-desc" id="statusDesc">请连接 CO2 传感器设备</div>
            </div>
        </div>

        <!-- 统计栏 -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">最低</div>
                <div class="stat-value color-good" id="statMin">---</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">平均</div>
                <div class="stat-value" id="statAvg">---</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">最高</div>
                <div class="stat-value color-bad" id="statMax">---</div>
            </div>
        </div>

        <!-- 历史趋势图表 -->
        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>

        <!-- 操作按钮 -->
        <div class="button-row">
            <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/>
                </svg>
                连接设备
            </button>
        </div>

        <div class="button-row">
            <button class="btn btn-secondary" onclick="exportData()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                导出数据
            </button>
            <button class="btn btn-danger" onclick="clearHistory()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                清空历史
            </button>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar">
            已记录 <span class="record-count" id="recordCount">0</span> 条数据
        </div>
    </div>

    <script>
        // ============ 全局变量 ============
        let device = null;
        let characteristic = null;
        let isConnected = false;
        let chart = null;
        let historyData = [];

        const MAX_HISTORY = 10000;
        const CHART_POINTS = 60;
        const STORAGE_KEY = 'co2_history';

        // BLE 配置
        const BLE_CONFIG = {
            deviceName: 'CO2-Sensor',
            serviceUUID: 0x181A,
            characteristicUUID: 0x2B8C
        };

        // 空气质量等级
        const AIR_QUALITY = {
            good: { max: 800, color: 'good', text: '优良', desc: '空气质量良好，适合各种活动' },
            moderate: { max: 1500, color: 'moderate', text: '一般', desc: '建议适当通风换气' },
            bad: { max: Infinity, color: 'bad', text: '较差', desc: '请立即开窗通风' }
        };

        // ============ 初始化 ============
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            initChart();
            updateUI();
            registerServiceWorker();
        });

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker 注册成功'))
                    .catch(err => console.log('Service Worker 注册失败:', err));
            }
        }

        // ============ BLE 连接 ============
        async function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                await connect();
            }
        }

        async function connect() {
            const btn = document.getElementById('connectBtn');

            if (!navigator.bluetooth) {
                alert('您的浏览器不支持 Web Bluetooth。请使用 Chrome 或 Edge 浏览器。');
                return;
            }

            try {
                btn.classList.add('connecting');
                btn.innerHTML = '<span>连接中...</span>';
                updateConnectionStatus('正在搜索设备...');

                // 请求设备
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: BLE_CONFIG.deviceName }],
                    optionalServices: [BLE_CONFIG.serviceUUID]
                });

                updateConnectionStatus('正在连接...');

                // 监听断开事件
                device.addEventListener('gattserverdisconnected', onDisconnected);

                // 连接 GATT 服务器
                const server = await device.gatt.connect();

                // 获取服务
                const service = await server.getPrimaryService(BLE_CONFIG.serviceUUID);

                // 获取特征值
                characteristic = await service.getCharacteristic(BLE_CONFIG.characteristicUUID);

                // 启动通知
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);

                isConnected = true;
                updateConnectionStatus('已连接: ' + device.name);
                btn.classList.remove('connecting');
                btn.classList.add('connected');
                btn.innerHTML = '<span>断开连接</span>';

            } catch (error) {
                console.error('连接失败:', error);
                btn.classList.remove('connecting');
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/></svg> 连接设备';

                if (error.name !== 'NotFoundError') {
                    updateConnectionStatus('连接失败，请重试');
                } else {
                    updateConnectionStatus('未选择设备');
                }
            }
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            onDisconnected();
        }

        function onDisconnected() {
            isConnected = false;
            device = null;
            characteristic = null;

            const btn = document.getElementById('connectBtn');
            btn.classList.remove('connected', 'connecting');
            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/></svg> 连接设备';
            updateConnectionStatus('连接已断开');
        }

        function handleData(event) {
            const value = event.target.value;
            const co2 = value.getUint16(0, true); // Little Endian

            // 添加到历史记录
            const record = {
                time: Date.now(),
                co2: co2
            };

            historyData.push(record);

            // 限制最大记录数
            if (historyData.length > MAX_HISTORY) {
                historyData = historyData.slice(-MAX_HISTORY);
            }

            // 保存到 localStorage
            saveHistory();

            // 更新 UI
            updateUI();
        }

        // ============ 数据存储 ============
        function loadHistory() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    historyData = JSON.parse(saved);
                }
            } catch (e) {
                console.error('加载历史数据失败:', e);
                historyData = [];
            }
        }

        function saveHistory() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
            } catch (e) {
                console.error('保存历史数据失败:', e);
                // 存储满了，删除一半旧数据
                if (e.name === 'QuotaExceededError') {
                    historyData = historyData.slice(-Math.floor(MAX_HISTORY / 2));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
                }
            }
        }

        function clearHistory() {
            if (confirm('确定要清空所有历史数据吗？')) {
                historyData = [];
                localStorage.removeItem(STORAGE_KEY);
                updateUI();
            }
        }

        // ============ UI 更新 ============
        function updateUI() {
            updateCurrentValue();
            updateStats();
            updateChart();
            updateRecordCount();
        }

        function updateCurrentValue() {
            const valueEl = document.getElementById('co2Value');
            const indicatorEl = document.getElementById('statusIndicator');
            const textEl = document.getElementById('statusText');
            const descEl = document.getElementById('statusDesc');

            if (historyData.length === 0) {
                valueEl.textContent = '---';
                valueEl.className = 'co2-value color-good';
                indicatorEl.className = 'status-indicator bg-good';
                textEl.textContent = '等待连接';
                descEl.textContent = '请连接 CO2 传感器设备';
                return;
            }

            const latest = historyData[historyData.length - 1].co2;
            valueEl.textContent = latest;

            const quality = getAirQuality(latest);
            valueEl.className = 'co2-value color-' + quality.color;
            indicatorEl.className = 'status-indicator bg-' + quality.color;
            textEl.textContent = quality.text;
            descEl.textContent = quality.desc;
        }

        function updateStats() {
            const minEl = document.getElementById('statMin');
            const avgEl = document.getElementById('statAvg');
            const maxEl = document.getElementById('statMax');

            if (historyData.length === 0) {
                minEl.textContent = '---';
                avgEl.textContent = '---';
                maxEl.textContent = '---';
                return;
            }

            const values = historyData.map(d => d.co2);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const avg = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

            minEl.textContent = min;
            avgEl.textContent = avg;
            maxEl.textContent = max;
        }

        function updateRecordCount() {
            document.getElementById('recordCount').textContent = historyData.length;
        }

        function updateConnectionStatus(text) {
            document.getElementById('connectionStatus').textContent = text;
        }

        function getAirQuality(co2) {
            if (co2 <= AIR_QUALITY.good.max) {
                return AIR_QUALITY.good;
            } else if (co2 <= AIR_QUALITY.moderate.max) {
                return AIR_QUALITY.moderate;
            } else {
                return AIR_QUALITY.bad;
            }
        }

        // ============ 图表 ============
        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CO2 (ppm)',
                        data: [],
                        borderColor: '#4a90d9',
                        backgroundColor: 'rgba(74, 144, 217, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHitRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#252542',
                            titleColor: '#fff',
                            bodyColor: '#4a90d9',
                            borderColor: '#4a90d9',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666'
                            },
                            suggestedMin: 400,
                            suggestedMax: 1200
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function updateChart() {
            if (!chart) return;

            const recentData = historyData.slice(-CHART_POINTS);

            const labels = recentData.map(d => {
                const date = new Date(d.time);
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            });

            const values = recentData.map(d => d.co2);

            chart.data.labels = labels;
            chart.data.datasets[0].data = values;
            chart.update('none');
        }

        // ============ 数据导出 ============
        function exportData() {
            if (historyData.length === 0) {
                alert('没有可导出的数据');
                return;
            }

            // 生成 CSV 内容
            let csv = 'Time,CO2 (ppm)\n';
            historyData.forEach(d => {
                const date = new Date(d.time);
                const timeStr = date.toLocaleString('zh-CN');
                csv += `"${timeStr}",${d.co2}\n`;
            });

            // 创建下载链接
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CO2_Data_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
