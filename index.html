<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4a90d9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CO2 Monitor</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            padding: 16px;
            padding-bottom: env(safe-area-inset-bottom, 16px);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* æ ‡é¢˜æ  */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a90d9;
        }

        .header .subtitle {
            font-size: 0.875rem;
            color: #888;
            margin-top: 4px;
        }

        /* ä¸»æ•°å€¼æ˜¾ç¤ºåŒº */
        .main-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .co2-value {
            font-size: 5rem;
            font-weight: 700;
            line-height: 1;
            transition: color 0.3s ease;
        }

        .co2-unit {
            font-size: 1.5rem;
            color: #888;
            margin-left: 8px;
        }

        /* ç©ºæ°”è´¨é‡çŠ¶æ€å¡ç‰‡ */
        .status-card {
            background-color: #252542;
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-text {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .status-desc {
            font-size: 0.875rem;
            color: #888;
            margin-top: 2px;
        }

        /* æ¸©æ¹¿åº¦æ˜¾ç¤º */
        .env-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .env-card {
            flex: 1;
            background-color: #252542;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .env-icon {
            font-size: 1.5rem;
        }

        .env-data {
            flex: 1;
        }

        .env-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .env-unit {
            font-size: 0.875rem;
            color: #888;
            margin-left: 2px;
        }

        .env-label {
            font-size: 0.75rem;
            color: #888;
        }

        /* ç»Ÿè®¡æ  */
        .stats-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            flex: 1;
            background-color: #252542;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 4px;
        }

        /* å›¾è¡¨åŒº */
        .chart-section-title {
            font-size: 0.875rem;
            color: #888;
            margin-bottom: 8px;
            margin-top: 8px;
            font-weight: 500;
        }

        .chart-container {
            background-color: #252542;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            height: 180px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* æ“ä½œæŒ‰é’® */
        .button-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #4a90d9;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a7fc8;
        }

        .btn-primary:disabled {
            background-color: #3a5a7a;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #3a3a5a;
            color: #ccc;
        }

        .btn-secondary:hover {
            background-color: #4a4a6a;
        }

        .btn-danger {
            background-color: #5a2a2a;
            color: #ff8888;
        }

        .btn-danger:hover {
            background-color: #6a3a3a;
        }

        .btn.connected {
            background-color: #2a5a3a;
            color: #88ff88;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            text-align: center;
            font-size: 0.875rem;
            color: #666;
        }

        .status-bar .record-count {
            color: #4a90d9;
        }

        /* é¢œè‰²å®šä¹‰ */
        .color-good { color: #00c853; }
        .color-moderate { color: #ffc107; }
        .color-bad { color: #ff5252; }

        .bg-good { background-color: #00c853; }
        .bg-moderate { background-color: #ffc107; }
        .bg-bad { background-color: #ff5252; }

        /* å“åº”å¼ - å°å±å¹• */
        @media (max-width: 359px) {
            body {
                padding: 12px;
            }
            .co2-value {
                font-size: 3.5rem;
            }
            .stat-value {
                font-size: 1.25rem;
            }
            .btn {
                padding: 12px;
                font-size: 0.875rem;
            }
        }

        /* å“åº”å¼ - å¤§å±å¹• */
        @media (min-width: 601px) {
            .co2-value {
                font-size: 6rem;
            }
            .chart-container {
                height: 250px;
            }
        }

        /* è¿æ¥çŠ¶æ€åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connecting {
            animation: pulse 1s infinite;
        }

        /* åŠŸèƒ½å¼€å…³æŒ‰é’® */
        .toggle-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            flex: 0 0 44px;
            border-radius: 12px;
            background-color: #3a3a5a;
            color: #888;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .toggle-btn.active {
            background-color: #4a90d9;
            color: white;
        }

        .toggle-btn:hover {
            background-color: #4a4a6a;
        }

        .toggle-btn.active:hover {
            background-color: #3a7fc8;
        }

        /* å›¾è¡¨æ—¶é—´èŒƒå›´æŒ‰é’®ç»„ */
        .chart-header {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .range-btn {
            padding: 5px 10px;
            border-radius: 14px;
            background: #3a3a5a;
            color: #888;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
        }

        .range-btn.active {
            background: #4a90d9;
            color: white;
        }

        .range-btn:hover {
            background: #4a4a6a;
        }

        .range-btn.active:hover {
            background: #3a7fc8;
        }

        /* ç»Ÿè®¡æ ‡ç­¾åˆ‡æ¢ */
        .stats-header {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .stats-tab {
            color: #666;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .stats-tab:hover {
            color: #888;
        }

        .stats-tab.active {
            color: #4a90d9;
            background-color: rgba(74, 144, 217, 0.1);
        }

        /* ç‰ˆæœ¬ä¿¡æ¯ */
        .version-info {
            margin-left: 12px;
            color: #444;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .version-info:active {
            color: #4a90d9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ ‡é¢˜æ  -->
        <div class="header">
            <h1>CO2 ä¾¿æºç›‘æµ‹å™¨</h1>
            <div class="subtitle" id="connectionStatus">æœªè¿æ¥è®¾å¤‡</div>
        </div>

        <!-- ä¸»æ•°å€¼æ˜¾ç¤ºåŒº -->
        <div class="main-display">
            <span class="co2-value color-good" id="co2Value">---</span>
            <span class="co2-unit">ppm</span>
        </div>

        <!-- ç©ºæ°”è´¨é‡çŠ¶æ€å¡ç‰‡ -->
        <div class="status-card">
            <div class="status-indicator bg-good" id="statusIndicator"></div>
            <div>
                <div class="status-text" id="statusText">ç­‰å¾…è¿æ¥</div>
                <div class="status-desc" id="statusDesc">è¯·è¿æ¥ CO2 ä¼ æ„Ÿå™¨è®¾å¤‡</div>
            </div>
        </div>

        <!-- æ¸©æ¹¿åº¦æ˜¾ç¤º -->
        <div class="env-row">
            <div class="env-card">
                <div class="env-icon">ğŸŒ¡ï¸</div>
                <div class="env-data">
                    <span class="env-value" id="tempValue">--</span>
                    <span class="env-unit">Â°C</span>
                </div>
                <div class="env-label">æ¸©åº¦</div>
            </div>
            <div class="env-card">
                <div class="env-icon">ğŸ’§</div>
                <div class="env-data">
                    <span class="env-value" id="humValue">--</span>
                    <span class="env-unit">%</span>
                </div>
                <div class="env-label">æ¹¿åº¦</div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ  -->
        <div class="stats-header">
            <span class="stats-tab active" data-range="session" onclick="setStatsRange('session')">æœ¬æ¬¡</span>
            <span class="stats-tab" data-range="all" onclick="setStatsRange('all')">å…¨éƒ¨</span>
        </div>
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">æœ€ä½</div>
                <div class="stat-value color-good" id="statMin">---</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡</div>
                <div class="stat-value" id="statAvg">---</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€é«˜</div>
                <div class="stat-value color-bad" id="statMax">---</div>
            </div>
        </div>

        <!-- å†å²è¶‹åŠ¿å›¾è¡¨ -->
        <div class="chart-header">
            <button class="range-btn active" data-minutes="30" onclick="setChartRange(30)">30åˆ†é’Ÿ</button>
            <button class="range-btn" data-minutes="360" onclick="setChartRange(360)">6å°æ—¶</button>
            <button class="range-btn" data-minutes="720" onclick="setChartRange(720)">12å°æ—¶</button>
            <button class="range-btn" data-minutes="1440" onclick="setChartRange(1440)">24å°æ—¶</button>
            <button class="range-btn" data-minutes="0" onclick="setChartRange(0)">å…¨éƒ¨</button>
        </div>

        <!-- CO2 è¶‹åŠ¿å›¾ -->
        <div class="chart-section-title">CO2 æµ“åº¦è¶‹åŠ¿</div>
        <div class="chart-container">
            <canvas id="co2Chart"></canvas>
        </div>

        <!-- æ¸©æ¹¿åº¦è¶‹åŠ¿å›¾ -->
        <div class="chart-section-title">æ¸©æ¹¿åº¦è¶‹åŠ¿</div>
        <div class="chart-container">
            <canvas id="envChart"></canvas>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="button-row">
            <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/>
                </svg>
                è¿æ¥è®¾å¤‡
            </button>
            <!-- æŠ¥è­¦å¼€å…³ -->
            <button class="toggle-btn active" id="alertToggle" onclick="toggleAlert()" title="CO2è¶…æ ‡æŠ¥è­¦">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
                </svg>
            </button>
            <!-- å±å¹•å¸¸äº®å¼€å…³ -->
            <button class="toggle-btn" id="wakeLockToggle" onclick="toggleWakeLock()" title="å±å¹•å¸¸äº®">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 15.31L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/>
                </svg>
            </button>
        </div>

        <div class="button-row">
            <button class="btn btn-secondary" onclick="exportData()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                å¯¼å‡ºæ•°æ®
            </button>
            <button class="btn btn-danger" onclick="clearHistory()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                æ¸…ç©ºå†å²
            </button>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            å·²è®°å½• <span class="record-count" id="recordCount">0</span> æ¡æ•°æ®
            <span class="version-info" id="versionInfo" onclick="checkForUpdates()" title="ç‚¹å‡»æ£€æŸ¥æ›´æ–°"></span>
        </div>
    </div>

    <script>
        // ============ ç‰ˆæœ¬å· ============
        const APP_VERSION = '1.1.0';

        // ============ å…¨å±€å˜é‡ ============
        let device = null;
        let characteristic = null;
        let isConnected = false;
        let co2Chart = null;
        let envChart = null;
        let historyData = [];

        const MAX_HISTORY = 10000;
        const CHART_POINTS = 60;
        const STORAGE_KEY = 'co2_history';

        // å±å¹•å¸¸äº®
        let wakeLock = null;
        let wakeLockEnabled = false;

        // CO2 è¶…æ ‡æŠ¥è­¦
        let alertEnabled = true;
        let lastAlertTime = 0;
        const ALERT_THRESHOLD = 1500;
        const ALERT_COOLDOWN = 60000; // 60ç§’å†·å´
        let audioContext = null;

        // å›¾è¡¨æ—¶é—´èŒƒå›´ï¼ˆåˆ†é’Ÿï¼Œ0è¡¨ç¤ºå…¨éƒ¨ï¼‰
        let chartRange = 30;

        // æœ¬æ¬¡ä¼šè¯ç»Ÿè®¡
        let sessionStartIndex = -1; // -1 è¡¨ç¤ºæœªè¿æ¥
        let statsRange = 'session'; // 'session' æˆ– 'all'

        // å½“å‰æ¸©æ¹¿åº¦ï¼ˆä»å†å²æ•°æ®æˆ–å®æ—¶æ•°æ®è·å–ï¼‰
        let currentTemp = null;
        let currentHum = null;

        // BLE é…ç½®
        const BLE_CONFIG = {
            deviceName: 'CO2-Sensor',
            serviceUUID: 0x181A,
            co2CharUUID: 0x2B8C,
            tempCharUUID: 0x2A6E,  // Temperature
            humCharUUID: 0x2A6F,   // Humidity
            // è‡ªå®šä¹‰ UUID (å†å²æ•°æ®ç›¸å…³)
            historyCountUUID: '00000001-1234-5678-1234-56789abcdef0',
            historyDataUUID: '00000002-1234-5678-1234-56789abcdef0',
            currentUptimeUUID: '00000003-1234-5678-1234-56789abcdef0',
            historyPopUUID: '00000005-1234-5678-1234-56789abcdef0',
            historyBatchUUID: '00000006-1234-5678-1234-56789abcdef0'  // æ‰¹é‡åŒæ­¥ï¼Œæ•ˆç‡æ›´é«˜
        };

        // å†å²æ•°æ®è¯»å–çŠ¶æ€
        let historyCharacteristics = {};
        let isLoadingHistory = false;

        // ç©ºæ°”è´¨é‡ç­‰çº§
        const AIR_QUALITY = {
            good: { max: 800, color: 'good', text: 'ä¼˜è‰¯', desc: 'ç©ºæ°”è´¨é‡è‰¯å¥½ï¼Œé€‚åˆå„ç§æ´»åŠ¨' },
            moderate: { max: 1500, color: 'moderate', text: 'ä¸€èˆ¬', desc: 'å»ºè®®é€‚å½“é€šé£æ¢æ°”' },
            bad: { max: Infinity, color: 'bad', text: 'è¾ƒå·®', desc: 'è¯·ç«‹å³å¼€çª—é€šé£' }
        };

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            initChart();
            updateUI();
            updateEnvDisplay();
            registerServiceWorker();
            setupVisibilityHandler();
            // å°è¯•è‡ªåŠ¨é‡è¿ä¹‹å‰é…å¯¹çš„è®¾å¤‡
            tryAutoReconnect();
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†ï¼ˆä»åå°æ¢å¤æ—¶æ£€æµ‹è¿æ¥ï¼‰
        function setupVisibilityHandler() {
            document.addEventListener('visibilitychange', async () => {
                if (document.visibilityState === 'visible') {
                    // é¡µé¢æ¢å¤å¯è§ï¼Œé‡æ–°è·å– Wake Lock
                    if (wakeLockEnabled && isConnected) {
                        await requestWakeLock();
                    }
                    // å¦‚æœæœªè¿æ¥ï¼Œå°è¯•è‡ªåŠ¨é‡è¿
                    if (!isConnected) {
                        tryAutoReconnect();
                    }
                } else {
                    // é¡µé¢éšè—ï¼Œé‡Šæ”¾ Wake Lockï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œä½†æˆ‘ä»¬ä¹Ÿä¸»åŠ¨é‡Šæ”¾ï¼‰
                    releaseWakeLock();
                }
            });
        }

        // æ‰‹åŠ¨æ£€æŸ¥æ›´æ–°ï¼ˆç‚¹å‡»ç‰ˆæœ¬å·è§¦å‘ï¼‰
        async function checkForUpdates() {
            if (!('serviceWorker' in navigator)) {
                alert('æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
                return;
            }

            const versionEl = document.getElementById('versionInfo');
            const originalText = versionEl.textContent;
            versionEl.textContent = 'æ£€æŸ¥ä¸­...';

            try {
                const reg = await navigator.serviceWorker.getRegistration();
                if (reg) {
                    await reg.update();
                    // ç­‰å¾…ä¸€ä¸‹çœ‹æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    if (reg.waiting) {
                        // æœ‰æ–°ç‰ˆæœ¬ç­‰å¾…å®‰è£…
                        if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                            location.reload();
                        }
                    } else {
                        alert('å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ' + APP_VERSION);
                    }
                }
            } catch (err) {
                alert('æ£€æŸ¥æ›´æ–°å¤±è´¥: ' + err.message);
            }

            versionEl.textContent = originalText;
        }

        // è‡ªåŠ¨é‡è¿ä¹‹å‰é…å¯¹çš„è®¾å¤‡
        async function tryAutoReconnect() {
            if (!navigator.bluetooth || !navigator.bluetooth.getDevices) {
                return; // æµè§ˆå™¨ä¸æ”¯æŒ getDevices API
            }

            try {
                updateConnectionStatus('æ­£åœ¨æŸ¥æ‰¾å·²é…å¯¹è®¾å¤‡...');
                const devices = await navigator.bluetooth.getDevices();

                // æŸ¥æ‰¾æˆ‘ä»¬çš„ CO2 ä¼ æ„Ÿå™¨
                const co2Device = devices.find(d => d.name === BLE_CONFIG.deviceName);

                if (co2Device) {
                    updateConnectionStatus('å‘ç°è®¾å¤‡ï¼Œæ­£åœ¨è‡ªåŠ¨é‡è¿...');
                    await connectToDevice(co2Device);
                } else {
                    updateConnectionStatus('æœªæ‰¾åˆ°å·²é…å¯¹è®¾å¤‡ï¼Œè¯·æ‰‹åŠ¨è¿æ¥');
                }
            } catch (error) {
                console.log('è‡ªåŠ¨é‡è¿å¤±è´¥:', error);
                updateConnectionStatus('è‡ªåŠ¨é‡è¿å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿æ¥');
            }
        }

        function registerServiceWorker() {
            // æ˜¾ç¤ºç‰ˆæœ¬å·
            document.getElementById('versionInfo').textContent = 'v' + APP_VERSION;

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker æ³¨å†ŒæˆåŠŸ'))
                    .catch(err => console.log('Service Worker æ³¨å†Œå¤±è´¥:', err));
            }
        }

        // ============ BLE è¿æ¥ ============
        async function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                await connect();
            }
        }

        async function connect() {
            const btn = document.getElementById('connectBtn');

            if (!navigator.bluetooth) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Bluetoothã€‚è¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨ã€‚');
                return;
            }

            try {
                btn.classList.add('connecting');
                btn.innerHTML = '<span>è¿æ¥ä¸­...</span>';
                updateConnectionStatus('æ­£åœ¨æœç´¢è®¾å¤‡...');

                // è¯·æ±‚è®¾å¤‡ï¼ˆéœ€è¦ç”¨æˆ·æ‰‹åŠ¿ï¼‰
                const selectedDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: BLE_CONFIG.deviceName }],
                    optionalServices: [BLE_CONFIG.serviceUUID]
                });

                await connectToDevice(selectedDevice);

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                btn.classList.remove('connecting');
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/></svg> è¿æ¥è®¾å¤‡';

                if (error.name !== 'NotFoundError') {
                    updateConnectionStatus('è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•');
                } else {
                    updateConnectionStatus('æœªé€‰æ‹©è®¾å¤‡');
                }
            }
        }

        // è¿æ¥åˆ°æŒ‡å®šè®¾å¤‡ï¼ˆæ‰‹åŠ¨è¿æ¥å’Œè‡ªåŠ¨é‡è¿å…±ç”¨ï¼‰
        async function connectToDevice(targetDevice) {
            const btn = document.getElementById('connectBtn');
            btn.classList.add('connecting');
            btn.innerHTML = '<span>è¿æ¥ä¸­...</span>';

            updateConnectionStatus('æ­£åœ¨è¿æ¥...');

            // ç›‘å¬æ–­å¼€äº‹ä»¶
            targetDevice.addEventListener('gattserverdisconnected', onDisconnected);

            // è¿æ¥ GATT æœåŠ¡å™¨
            const server = await targetDevice.gatt.connect();

            // è·å–æœåŠ¡
            const service = await server.getPrimaryService(BLE_CONFIG.serviceUUID);

            // è·å–å®æ—¶æ•°æ®ç‰¹å¾å€¼
            characteristic = await service.getCharacteristic(BLE_CONFIG.co2CharUUID);

            // è·å–æ¸©æ¹¿åº¦ç‰¹å¾å€¼ï¼ˆå¯é€‰ï¼‰
            let tempChar = null, humChar = null;
            try {
                tempChar = await service.getCharacteristic(BLE_CONFIG.tempCharUUID);
                humChar = await service.getCharacteristic(BLE_CONFIG.humCharUUID);
            } catch (e) {
                console.log('æ¸©æ¹¿åº¦ç‰¹å¾å€¼ä¸å¯ç”¨:', e);
            }

            // è·å–å†å²æ•°æ®ç›¸å…³ç‰¹å¾å€¼
            try {
                historyCharacteristics.count = await service.getCharacteristic(BLE_CONFIG.historyCountUUID);
                historyCharacteristics.uptime = await service.getCharacteristic(BLE_CONFIG.currentUptimeUUID);
                historyCharacteristics.batch = await service.getCharacteristic(BLE_CONFIG.historyBatchUUID);
            } catch (e) {
                console.log('å†å²æ•°æ®ç‰¹å¾å€¼ä¸å¯ç”¨:', e);
                historyCharacteristics = {};
            }

            // å¯åŠ¨ CO2 é€šçŸ¥
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handleCO2Data);

            // å¯åŠ¨æ¸©æ¹¿åº¦é€šçŸ¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (tempChar) {
                await tempChar.startNotifications();
                tempChar.addEventListener('characteristicvaluechanged', handleTempData);
            }
            if (humChar) {
                await humChar.startNotifications();
                humChar.addEventListener('characteristicvaluechanged', handleHumData);
            }

            device = targetDevice;
            isConnected = true;
            btn.classList.remove('connecting');
            btn.classList.add('connected');
            btn.innerHTML = '<span>æ–­å¼€è¿æ¥</span>';

            // å¦‚æœå±å¹•å¸¸äº®å·²å¯ç”¨ï¼Œè¯·æ±‚ Wake Lock
            if (wakeLockEnabled) {
                await requestWakeLock();
            }

            // è¯»å–è®¾å¤‡å†å²æ•°æ®ï¼ˆä½¿ç”¨ History Batch æ‰¹é‡åŒæ­¥ï¼‰
            if (historyCharacteristics.batch) {
                await loadHistoryFromDevice();
            } else {
                updateConnectionStatus('å·²è¿æ¥: ' + device.name);
            }

            // è®°å½•æœ¬æ¬¡ä¼šè¯å¼€å§‹ç´¢å¼•ï¼ˆåœ¨å†å²æ•°æ®åŠ è½½å®Œæˆåï¼‰
            sessionStartIndex = historyData.length;
        }

        // ä»è®¾å¤‡è¯»å–å†å²æ•°æ®ï¼ˆä½¿ç”¨ History Batch æ‰¹é‡æ–¹å¼ï¼Œæ•ˆç‡æ›´é«˜ï¼‰
        async function loadHistoryFromDevice() {
            if (isLoadingHistory || !historyCharacteristics.batch) return;

            isLoadingHistory = true;
            const newRecords = [];  // ç§»åˆ° try å¤–éƒ¨ï¼Œç¡®ä¿ catch ä¸­å¯ä»¥è®¿é—®

            try {
                // 1. è¯»å–å†å²è®°å½•æ•°é‡ï¼ˆç”¨äºæ˜¾ç¤ºè¿›åº¦ï¼‰
                updateConnectionStatus('è¯»å–å†å²æ•°æ®æ•°é‡...');
                const countValue = await historyCharacteristics.count.readValue();
                const totalCount = countValue.getUint16(0, true);

                if (totalCount === 0) {
                    updateConnectionStatus('å·²è¿æ¥: ' + device.name + ' (æ— å†å²æ•°æ®)');
                    isLoadingHistory = false;
                    return;
                }

                // 2. è¯»å–å½“å‰è®¾å¤‡ uptimeï¼ˆç”¨äºè®¡ç®—çœŸå®æ—¶é—´ï¼‰
                const uptimeValue = await historyCharacteristics.uptime.readValue();
                const currentUptime = uptimeValue.getUint32(0, true);
                const currentTime = Date.now();

                // 3. ä½¿ç”¨ History Batch æ‰¹é‡è¯»å–ï¼ˆæ¯æ¬¡è¯»å–å¤šæ¡ï¼Œè¯»å–åè‡ªåŠ¨ä»è®¾å¤‡åˆ é™¤ï¼‰
                let syncCount = 0;

                while (true) {
                    updateConnectionStatus(`åŒæ­¥å†å²æ•°æ® ${syncCount}/${totalCount}...`);

                    // å†™å…¥ 0 è¯·æ±‚ MTU å…è®¸çš„æœ€å¤§æ‰¹é‡
                    await historyCharacteristics.batch.writeValue(new Uint8Array([0]));

                    // è¯»å–æ‰¹é‡æ•°æ®ï¼š[actual_count (1 byte)][records... (11 bytes each)]
                    const response = await historyCharacteristics.batch.readValue();
                    const actualCount = response.getUint8(0);

                    if (actualCount === 0) {
                        // æ²¡æœ‰æ›´å¤šæ•°æ®ï¼ŒåŒæ­¥å®Œæˆ
                        break;
                    }

                    // è§£ææ‰¹é‡è®°å½•
                    for (let i = 0; i < actualCount; i++) {
                        const offset = 1 + i * 11;  // è·³è¿‡ actual_count å­—èŠ‚

                        const recordUptime = response.getUint32(offset, true);
                        const co2 = response.getUint16(offset + 4, true);
                        const tempRaw = response.getInt16(offset + 6, true);   // 0.01Â°C
                        const humRaw = response.getUint16(offset + 8, true);   // 0.01%
                        const valid = response.getUint8(offset + 10);

                        if (valid === 1) {
                            // è®¡ç®—çœŸå®æ—¶é—´
                            const secondsAgo = currentUptime - recordUptime;
                            const recordTime = currentTime - secondsAgo * 1000;

                            newRecords.push({
                                time: recordTime,
                                co2: co2,
                                temp: tempRaw / 100,
                                hum: humRaw / 100,
                                fromDevice: true
                            });
                        }
                    }

                    syncCount += actualCount;
                }

                // 4. åˆå¹¶å†å²æ•°æ®ï¼ˆé¿å…é‡å¤ï¼ŒæŒ‰æ—¶é—´æ’åºï¼‰
                if (newRecords.length > 0) {
                    mergeHistoryData(newRecords);
                    saveHistory();
                    updateUI();

                    // æ›´æ–°å½“å‰æ¸©æ¹¿åº¦ä¸ºæœ€æ–°è®°å½•çš„å€¼
                    const latest = newRecords[newRecords.length - 1];
                    if (latest.temp !== undefined) currentTemp = latest.temp;
                    if (latest.hum !== undefined) currentHum = latest.hum;
                    updateEnvDisplay();
                }

                updateConnectionStatus(`å·²è¿æ¥: ${device.name} (åŒæ­¥${newRecords.length}æ¡å†å²)`);

            } catch (error) {
                console.error('è¯»å–å†å²æ•°æ®å¤±è´¥:', error);
                // å³ä½¿å‘ç”Ÿé”™è¯¯ï¼Œä¹Ÿè¦ä¿å­˜å·²è¯»å–çš„æ•°æ®
                if (newRecords && newRecords.length > 0) {
                    mergeHistoryData(newRecords);
                    saveHistory();
                    updateUI();
                    updateConnectionStatus(`å·²è¿æ¥: ${device.name} (éƒ¨åˆ†åŒæ­¥${newRecords.length}æ¡)`);
                } else {
                    updateConnectionStatus('å·²è¿æ¥: ' + device.name + ' (å†å²æ•°æ®è¯»å–å¤±è´¥)');
                }
            }

            isLoadingHistory = false;
        }

        // åˆå¹¶è®¾å¤‡å†å²æ•°æ®åˆ°æœ¬åœ°æ•°æ®
        function mergeHistoryData(newRecords) {
            if (newRecords.length === 0) return;

            // è·å–æ–°æ•°æ®çš„æ—¶é—´èŒƒå›´
            const minNewTime = Math.min(...newRecords.map(r => r.time));
            const maxNewTime = Math.max(...newRecords.map(r => r.time));

            // è¿‡æ»¤æ‰æœ¬åœ°æ•°æ®ä¸­ä¸æ–°æ•°æ®æ—¶é—´é‡å çš„éƒ¨åˆ†ï¼ˆ5ç§’å®¹å·®ï¼‰
            const tolerance = 5000;
            const filteredLocal = historyData.filter(r => {
                return r.time < minNewTime - tolerance || r.time > maxNewTime + tolerance;
            });

            // åˆå¹¶å¹¶æŒ‰æ—¶é—´æ’åº
            historyData = [...filteredLocal, ...newRecords].sort((a, b) => a.time - b.time);

            // é™åˆ¶æœ€å¤§è®°å½•æ•°
            if (historyData.length > MAX_HISTORY) {
                historyData = historyData.slice(-MAX_HISTORY);
            }
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            onDisconnected();
        }

        function onDisconnected() {
            isConnected = false;
            device = null;
            characteristic = null;
            historyCharacteristics = {};
            isLoadingHistory = false;

            // é‡ç½®æ¸©æ¹¿åº¦
            currentTemp = null;
            currentHum = null;
            document.getElementById('tempValue').textContent = '--';
            document.getElementById('humValue').textContent = '--';

            // é‡ç½®ä¼šè¯ç»Ÿè®¡
            sessionStartIndex = -1;

            // é‡Šæ”¾ Wake Lock
            releaseWakeLock();

            const btn = document.getElementById('connectBtn');
            btn.classList.remove('connected', 'connecting');
            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/></svg> è¿æ¥è®¾å¤‡';
            updateConnectionStatus('è¿æ¥å·²æ–­å¼€');

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            updateStats();
        }

        function handleCO2Data(event) {
            const value = event.target.value;
            const co2 = value.getUint16(0, true); // Little Endian

            // æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆåŒ…å«å½“å‰æ¸©æ¹¿åº¦ï¼‰
            const record = {
                time: Date.now(),
                co2: co2,
                temp: currentTemp,
                hum: currentHum
            };

            historyData.push(record);

            // é™åˆ¶æœ€å¤§è®°å½•æ•°
            if (historyData.length > MAX_HISTORY) {
                historyData = historyData.slice(-MAX_HISTORY);
                // è°ƒæ•´ä¼šè¯èµ·å§‹ç´¢å¼•
                if (sessionStartIndex > 0) {
                    sessionStartIndex = Math.max(0, sessionStartIndex - 1);
                }
            }

            // ä¿å­˜åˆ° localStorage
            saveHistory();

            // æ£€æµ‹ CO2 è¶…æ ‡æŠ¥è­¦
            if (alertEnabled && co2 > ALERT_THRESHOLD) {
                triggerAlert(co2);
            }

            // æ›´æ–° UI
            updateUI();
        }

        function handleTempData(event) {
            const value = event.target.value;
            // æ¸©åº¦: int16, 0.01Â°C å•ä½
            const tempRaw = value.getInt16(0, true);
            currentTemp = tempRaw / 100;
            updateEnvDisplay();
        }

        function handleHumData(event) {
            const value = event.target.value;
            // æ¹¿åº¦: uint16, 0.01% å•ä½
            const humRaw = value.getUint16(0, true);
            currentHum = humRaw / 100;
            updateEnvDisplay();
        }

        function updateEnvDisplay() {
            const tempEl = document.getElementById('tempValue');
            const humEl = document.getElementById('humValue');

            if (currentTemp !== null) {
                tempEl.textContent = currentTemp.toFixed(1);
            }
            if (currentHum !== null) {
                humEl.textContent = currentHum.toFixed(1);
            }
        }

        // ============ æ•°æ®å­˜å‚¨ ============
        function loadHistory() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    historyData = JSON.parse(saved);
                    // ä»å†å²æ•°æ®æ¢å¤æœ€æ–°æ¸©æ¹¿åº¦
                    if (historyData.length > 0) {
                        const latest = historyData[historyData.length - 1];
                        if (latest.temp !== undefined) currentTemp = latest.temp;
                        if (latest.hum !== undefined) currentHum = latest.hum;
                    }
                }
            } catch (e) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', e);
                historyData = [];
            }
        }

        function saveHistory() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
            } catch (e) {
                console.error('ä¿å­˜å†å²æ•°æ®å¤±è´¥:', e);
                // å­˜å‚¨æ»¡äº†ï¼Œåˆ é™¤ä¸€åŠæ—§æ•°æ®
                if (e.name === 'QuotaExceededError') {
                    historyData = historyData.slice(-Math.floor(MAX_HISTORY / 2));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
                }
            }
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²æ•°æ®å—ï¼Ÿ')) {
                historyData = [];
                localStorage.removeItem(STORAGE_KEY);
                updateUI();
            }
        }

        // ============ UI æ›´æ–° ============
        function updateUI() {
            updateCurrentValue();
            updateStats();
            updateChart();
            updateRecordCount();
        }

        function updateCurrentValue() {
            const valueEl = document.getElementById('co2Value');
            const indicatorEl = document.getElementById('statusIndicator');
            const textEl = document.getElementById('statusText');
            const descEl = document.getElementById('statusDesc');

            if (historyData.length === 0) {
                valueEl.textContent = '---';
                valueEl.className = 'co2-value color-good';
                indicatorEl.className = 'status-indicator bg-good';
                textEl.textContent = 'ç­‰å¾…è¿æ¥';
                descEl.textContent = 'è¯·è¿æ¥ CO2 ä¼ æ„Ÿå™¨è®¾å¤‡';
                return;
            }

            const latest = historyData[historyData.length - 1].co2;
            valueEl.textContent = latest;

            const quality = getAirQuality(latest);
            valueEl.className = 'co2-value color-' + quality.color;
            indicatorEl.className = 'status-indicator bg-' + quality.color;
            textEl.textContent = quality.text;
            descEl.textContent = quality.desc;
        }

        function updateStats() {
            const minEl = document.getElementById('statMin');
            const avgEl = document.getElementById('statAvg');
            const maxEl = document.getElementById('statMax');

            // æ ¹æ®ç»Ÿè®¡èŒƒå›´è·å–æ•°æ®
            let dataToAnalyze;
            if (statsRange === 'session' && sessionStartIndex >= 0) {
                dataToAnalyze = historyData.slice(sessionStartIndex);
            } else {
                dataToAnalyze = historyData;
            }

            if (dataToAnalyze.length === 0) {
                minEl.textContent = '---';
                avgEl.textContent = '---';
                maxEl.textContent = '---';
                return;
            }

            const values = dataToAnalyze.map(d => d.co2);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const avg = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

            minEl.textContent = min;
            avgEl.textContent = avg;
            maxEl.textContent = max;
        }

        function setStatsRange(range) {
            statsRange = range;
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.stats-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.range === range);
            });
            updateStats();
        }

        function updateRecordCount() {
            document.getElementById('recordCount').textContent = historyData.length;
        }

        function updateConnectionStatus(text) {
            document.getElementById('connectionStatus').textContent = text;
        }

        function getAirQuality(co2) {
            if (co2 <= AIR_QUALITY.good.max) {
                return AIR_QUALITY.good;
            } else if (co2 <= AIR_QUALITY.moderate.max) {
                return AIR_QUALITY.moderate;
            } else {
                return AIR_QUALITY.bad;
            }
        }

        // ============ å›¾è¡¨ ============
        function initChart() {
            // åˆå§‹åŒ– CO2 è¶‹åŠ¿å›¾
            const co2Ctx = document.getElementById('co2Chart').getContext('2d');
            co2Chart = new Chart(co2Ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'CO2 (ppm)',
                            data: [],
                            borderColor: '#4a90d9',
                            backgroundColor: 'rgba(74, 144, 217, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHitRadius: 10,
                            spanGaps: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#252542',
                            titleColor: '#fff',
                            borderColor: '#4a90d9',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                maxTicksLimit: 6,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#4a90d9',
                                font: { size: 10 }
                            },
                            suggestedMin: 400,
                            suggestedMax: 1200,
                            title: {
                                display: true,
                                text: 'ppm',
                                color: '#4a90d9',
                                font: { size: 10 }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // åˆå§‹åŒ–æ¸©æ¹¿åº¦è¶‹åŠ¿å›¾
            const envCtx = document.getElementById('envChart').getContext('2d');
            envChart = new Chart(envCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'æ¸©åº¦ (Â°C)',
                            data: [],
                            borderColor: '#ff7043',
                            backgroundColor: 'rgba(255, 112, 67, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHitRadius: 10,
                            spanGaps: false,
                            yAxisID: 'y'
                        },
                        {
                            label: 'æ¹¿åº¦ (%)',
                            data: [],
                            borderColor: '#26c6da',
                            backgroundColor: 'rgba(38, 198, 218, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHitRadius: 10,
                            spanGaps: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#888',
                                boxWidth: 12,
                                padding: 8,
                                font: { size: 10 }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#252542',
                            titleColor: '#fff',
                            borderColor: '#888',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                maxTicksLimit: 6,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ff7043',
                                font: { size: 10 }
                            },
                            suggestedMin: 0,
                            suggestedMax: 40,
                            title: {
                                display: true,
                                text: 'Â°C',
                                color: '#ff7043',
                                font: { size: 10 }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: '#26c6da',
                                font: { size: 10 }
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            title: {
                                display: true,
                                text: '%',
                                color: '#26c6da',
                                font: { size: 10 }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function updateChart() {
            if (!co2Chart || !envChart) return;

            // æ ¹æ®æ—¶é—´èŒƒå›´è¿‡æ»¤æ•°æ®
            let filteredData;
            if (chartRange === 0) {
                filteredData = historyData;
            } else {
                const cutoff = Date.now() - chartRange * 60 * 1000;
                filteredData = historyData.filter(d => d.time >= cutoff);
            }

            const GAP_THRESHOLD = 30000; // 30ç§’æ— æ•°æ®è§†ä¸ºä¸­æ–­

            const labels = [];
            const co2Values = [];
            const tempValues = [];
            const humValues = [];

            filteredData.forEach((d, i) => {
                // æ£€æµ‹æ—¶é—´é—´éš”ï¼Œå¦‚æœè¶…è¿‡é˜ˆå€¼åˆ™æ’å…¥ null æ–­å¼€è¿çº¿
                if (i > 0) {
                    const gap = d.time - filteredData[i - 1].time;
                    if (gap > GAP_THRESHOLD) {
                        labels.push('');
                        co2Values.push(null);
                        tempValues.push(null);
                        humValues.push(null);
                    }
                }

                const date = new Date(d.time);
                labels.push(date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }));
                co2Values.push(d.co2);
                tempValues.push(d.temp !== undefined && d.temp !== null ? d.temp : null);
                humValues.push(d.hum !== undefined && d.hum !== null ? d.hum : null);
            });

            // æ›´æ–° CO2 å›¾è¡¨
            co2Chart.data.labels = labels;
            co2Chart.data.datasets[0].data = co2Values;
            co2Chart.update('none');

            // æ›´æ–°æ¸©æ¹¿åº¦å›¾è¡¨
            envChart.data.labels = labels;
            envChart.data.datasets[0].data = tempValues;
            envChart.data.datasets[1].data = humValues;

            // åŠ¨æ€è°ƒæ•´Yè½´èŒƒå›´ï¼Œä½¿å˜åŒ–æ›´æ˜æ˜¾
            const validTemps = tempValues.filter(v => v !== null && v !== undefined);
            const validHums = humValues.filter(v => v !== null && v !== undefined);

            if (validTemps.length > 0) {
                const minTemp = Math.min(...validTemps);
                const maxTemp = Math.max(...validTemps);
                const tempPadding = Math.max((maxTemp - minTemp) * 0.2, 1); // è‡³å°‘1åº¦è¾¹è·
                envChart.options.scales.y.min = Math.floor(minTemp - tempPadding);
                envChart.options.scales.y.max = Math.ceil(maxTemp + tempPadding);
            }

            if (validHums.length > 0) {
                const minHum = Math.min(...validHums);
                const maxHum = Math.max(...validHums);
                const humPadding = Math.max((maxHum - minHum) * 0.2, 2); // è‡³å°‘2%è¾¹è·
                envChart.options.scales.y1.min = Math.floor(minHum - humPadding);
                envChart.options.scales.y1.max = Math.ceil(maxHum + humPadding);
            }

            envChart.update('none');
        }

        function setChartRange(minutes) {
            chartRange = minutes;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.minutes) === minutes);
            });
            updateChart();
        }

        // ============ æ•°æ®å¯¼å‡º ============
        function exportData() {
            if (historyData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }

            // ç”Ÿæˆ CSV å†…å®¹ï¼ˆåŒ…å«æ¸©æ¹¿åº¦ï¼‰
            let csv = 'Time,CO2 (ppm),Temperature (Â°C),Humidity (%)\n';
            historyData.forEach(d => {
                const date = new Date(d.time);
                const timeStr = date.toLocaleString('zh-CN');
                const temp = d.temp !== null && d.temp !== undefined ? d.temp.toFixed(1) : '';
                const hum = d.hum !== null && d.hum !== undefined ? d.hum.toFixed(1) : '';
                csv += `"${timeStr}",${d.co2},${temp},${hum}\n`;
            });

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CO2_Data_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============ å±å¹•å¸¸äº® ============
        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) {
                console.log('Wake Lock API ä¸æ”¯æŒ');
                return;
            }

            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => {
                    console.log('Wake Lock å·²é‡Šæ”¾');
                });
                console.log('Wake Lock å·²æ¿€æ´»');
            } catch (err) {
                console.log('Wake Lock è¯·æ±‚å¤±è´¥:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        async function toggleWakeLock() {
            wakeLockEnabled = !wakeLockEnabled;
            const btn = document.getElementById('wakeLockToggle');
            btn.classList.toggle('active', wakeLockEnabled);

            if (wakeLockEnabled && isConnected) {
                await requestWakeLock();
            } else {
                releaseWakeLock();
            }
        }

        // ============ CO2 è¶…æ ‡æŠ¥è­¦ ============
        function toggleAlert() {
            alertEnabled = !alertEnabled;
            const btn = document.getElementById('alertToggle');
            btn.classList.toggle('active', alertEnabled);
        }

        function triggerAlert(co2) {
            const now = Date.now();

            // é˜²æŠ–ï¼šå†·å´æœŸå†…ä¸é‡å¤æŠ¥è­¦
            if (now - lastAlertTime < ALERT_COOLDOWN) {
                return;
            }

            lastAlertTime = now;

            // æŒ¯åŠ¨æé†’
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }

            // èœ‚é¸£å£°
            playAlertSound();

            console.log('CO2 è¶…æ ‡æŠ¥è­¦:', co2, 'ppm');
        }

        function playAlertSound() {
            try {
                // åˆ›å»ºæˆ–å¤ç”¨ AudioContext
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // ç¡®ä¿ AudioContext å¤„äºè¿è¡ŒçŠ¶æ€
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 880; // A5 éŸ³ç¬¦
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                // ç¬¬äºŒå£°
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();

                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);

                    osc2.frequency.value = 1100; // æ›´é«˜çš„éŸ³
                    osc2.type = 'sine';

                    gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    osc2.start(audioContext.currentTime);
                    osc2.stop(audioContext.currentTime + 0.5);
                }, 300);

            } catch (err) {
                console.log('æ’­æ”¾æŠ¥è­¦éŸ³å¤±è´¥:', err);
            }
        }
    </script>
</body>
</html>
