<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4a90d9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CO2 Monitor</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
            min-height: 100vh;
            padding: 16px;
            padding-bottom: env(safe-area-inset-bottom, 16px);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* 标题栏 */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a90d9;
        }

        .header .subtitle {
            font-size: 0.875rem;
            color: #888;
            margin-top: 4px;
        }

        /* 主数值显示区 */
        .main-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .co2-value {
            font-size: 5rem;
            font-weight: 700;
            line-height: 1;
            transition: color 0.3s ease;
        }

        .co2-unit {
            font-size: 1.5rem;
            color: #888;
            margin-left: 8px;
        }

        /* 空气质量状态卡片 */
        .status-card {
            background-color: #252542;
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-text {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .status-desc {
            font-size: 0.875rem;
            color: #888;
            margin-top: 2px;
        }

        /* 统计栏 */
        .stats-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            flex: 1;
            background-color: #252542;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 4px;
        }

        /* 图表区 */
        .chart-container {
            background-color: #252542;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            height: 200px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* 操作按钮 */
        .button-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #4a90d9;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a7fc8;
        }

        .btn-primary:disabled {
            background-color: #3a5a7a;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #3a3a5a;
            color: #ccc;
        }

        .btn-secondary:hover {
            background-color: #4a4a6a;
        }

        .btn-danger {
            background-color: #5a2a2a;
            color: #ff8888;
        }

        .btn-danger:hover {
            background-color: #6a3a3a;
        }

        .btn.connected {
            background-color: #2a5a3a;
            color: #88ff88;
        }

        /* 状态栏 */
        .status-bar {
            text-align: center;
            font-size: 0.875rem;
            color: #666;
        }

        .status-bar .record-count {
            color: #4a90d9;
        }

        /* 颜色定义 */
        .color-good { color: #00c853; }
        .color-moderate { color: #ffc107; }
        .color-bad { color: #ff5252; }

        .bg-good { background-color: #00c853; }
        .bg-moderate { background-color: #ffc107; }
        .bg-bad { background-color: #ff5252; }

        /* 响应式 - 小屏幕 */
        @media (max-width: 359px) {
            body {
                padding: 12px;
            }
            .co2-value {
                font-size: 3.5rem;
            }
            .stat-value {
                font-size: 1.25rem;
            }
            .btn {
                padding: 12px;
                font-size: 0.875rem;
            }
        }

        /* 响应式 - 大屏幕 */
        @media (min-width: 601px) {
            .co2-value {
                font-size: 6rem;
            }
            .chart-container {
                height: 250px;
            }
        }

        /* 连接状态动画 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .connecting {
            animation: pulse 1s infinite;
        }

        /* 功能开关按钮 */
        .toggle-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            flex: 0 0 44px;
            border-radius: 12px;
            background-color: #3a3a5a;
            color: #888;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .toggle-btn.active {
            background-color: #4a90d9;
            color: white;
        }

        .toggle-btn:hover {
            background-color: #4a4a6a;
        }

        .toggle-btn.active:hover {
            background-color: #3a7fc8;
        }

        /* 图表时间范围按钮组 */
        .chart-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .range-btn {
            padding: 6px 12px;
            border-radius: 16px;
            background: #3a3a5a;
            color: #888;
            border: none;
            cursor: pointer;
            font-size: 0.8125rem;
            transition: all 0.2s ease;
        }

        .range-btn.active {
            background: #4a90d9;
            color: white;
        }

        .range-btn:hover {
            background: #4a4a6a;
        }

        .range-btn.active:hover {
            background: #3a7fc8;
        }

        /* 统计标签切换 */
        .stats-header {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .stats-tab {
            color: #666;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .stats-tab:hover {
            color: #888;
        }

        .stats-tab.active {
            color: #4a90d9;
            background-color: rgba(74, 144, 217, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 标题栏 -->
        <div class="header">
            <h1>CO2 便携监测器</h1>
            <div class="subtitle" id="connectionStatus">未连接设备</div>
        </div>

        <!-- 主数值显示区 -->
        <div class="main-display">
            <span class="co2-value color-good" id="co2Value">---</span>
            <span class="co2-unit">ppm</span>
        </div>

        <!-- 空气质量状态卡片 -->
        <div class="status-card">
            <div class="status-indicator bg-good" id="statusIndicator"></div>
            <div>
                <div class="status-text" id="statusText">等待连接</div>
                <div class="status-desc" id="statusDesc">请连接 CO2 传感器设备</div>
            </div>
        </div>

        <!-- 统计栏 -->
        <div class="stats-header">
            <span class="stats-tab active" data-range="session" onclick="setStatsRange('session')">本次</span>
            <span class="stats-tab" data-range="all" onclick="setStatsRange('all')">全部</span>
        </div>
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">最低</div>
                <div class="stat-value color-good" id="statMin">---</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">平均</div>
                <div class="stat-value" id="statAvg">---</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">最高</div>
                <div class="stat-value color-bad" id="statMax">---</div>
            </div>
        </div>

        <!-- 历史趋势图表 -->
        <div class="chart-header">
            <button class="range-btn active" data-minutes="5" onclick="setChartRange(5)">5分钟</button>
            <button class="range-btn" data-minutes="30" onclick="setChartRange(30)">30分钟</button>
            <button class="range-btn" data-minutes="60" onclick="setChartRange(60)">1小时</button>
            <button class="range-btn" data-minutes="0" onclick="setChartRange(0)">全部</button>
        </div>
        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>

        <!-- 操作按钮 -->
        <div class="button-row">
            <button class="btn btn-primary" id="connectBtn" onclick="toggleConnection()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/>
                </svg>
                连接设备
            </button>
            <!-- 报警开关 -->
            <button class="toggle-btn active" id="alertToggle" onclick="toggleAlert()" title="CO2超标报警">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
                </svg>
            </button>
            <!-- 屏幕常亮开关 -->
            <button class="toggle-btn" id="wakeLockToggle" onclick="toggleWakeLock()" title="屏幕常亮">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 15.31L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/>
                </svg>
            </button>
        </div>

        <div class="button-row">
            <button class="btn btn-secondary" onclick="exportData()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                导出数据
            </button>
            <button class="btn btn-danger" onclick="clearHistory()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                清空历史
            </button>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar">
            已记录 <span class="record-count" id="recordCount">0</span> 条数据
        </div>
    </div>

    <script>
        // ============ 全局变量 ============
        let device = null;
        let characteristic = null;
        let isConnected = false;
        let chart = null;
        let historyData = [];

        const MAX_HISTORY = 10000;
        const CHART_POINTS = 60;
        const STORAGE_KEY = 'co2_history';

        // 屏幕常亮
        let wakeLock = null;
        let wakeLockEnabled = false;

        // CO2 超标报警
        let alertEnabled = true;
        let lastAlertTime = 0;
        const ALERT_THRESHOLD = 1500;
        const ALERT_COOLDOWN = 60000; // 60秒冷却
        let audioContext = null;

        // 图表时间范围（分钟，0表示全部）
        let chartRange = 5;

        // 本次会话统计
        let sessionStartIndex = -1; // -1 表示未连接
        let statsRange = 'session'; // 'session' 或 'all'

        // BLE 配置
        const BLE_CONFIG = {
            deviceName: 'CO2-Sensor',
            serviceUUID: 0x181A,
            characteristicUUID: 0x2B8C
        };

        // 空气质量等级
        const AIR_QUALITY = {
            good: { max: 800, color: 'good', text: '优良', desc: '空气质量良好，适合各种活动' },
            moderate: { max: 1500, color: 'moderate', text: '一般', desc: '建议适当通风换气' },
            bad: { max: Infinity, color: 'bad', text: '较差', desc: '请立即开窗通风' }
        };

        // ============ 初始化 ============
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            initChart();
            updateUI();
            registerServiceWorker();
            setupVisibilityHandler();
            // 尝试自动重连之前配对的设备
            tryAutoReconnect();
        });

        // 页面可见性变化处理（从后台恢复时检测连接）
        function setupVisibilityHandler() {
            document.addEventListener('visibilitychange', async () => {
                if (document.visibilityState === 'visible') {
                    // 页面恢复可见，重新获取 Wake Lock
                    if (wakeLockEnabled && isConnected) {
                        await requestWakeLock();
                    }
                    // 如果未连接，尝试自动重连
                    if (!isConnected) {
                        tryAutoReconnect();
                    }
                } else {
                    // 页面隐藏，释放 Wake Lock（系统会自动释放，但我们也主动释放）
                    releaseWakeLock();
                }
            });
        }

        // 自动重连之前配对的设备
        async function tryAutoReconnect() {
            if (!navigator.bluetooth || !navigator.bluetooth.getDevices) {
                return; // 浏览器不支持 getDevices API
            }

            try {
                updateConnectionStatus('正在查找已配对设备...');
                const devices = await navigator.bluetooth.getDevices();

                // 查找我们的 CO2 传感器
                const co2Device = devices.find(d => d.name === BLE_CONFIG.deviceName);

                if (co2Device) {
                    updateConnectionStatus('发现设备，正在自动重连...');
                    await connectToDevice(co2Device);
                } else {
                    updateConnectionStatus('未找到已配对设备，请手动连接');
                }
            } catch (error) {
                console.log('自动重连失败:', error);
                updateConnectionStatus('自动重连失败，请手动连接');
            }
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker 注册成功'))
                    .catch(err => console.log('Service Worker 注册失败:', err));
            }
        }

        // ============ BLE 连接 ============
        async function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                await connect();
            }
        }

        async function connect() {
            const btn = document.getElementById('connectBtn');

            if (!navigator.bluetooth) {
                alert('您的浏览器不支持 Web Bluetooth。请使用 Chrome 或 Edge 浏览器。');
                return;
            }

            try {
                btn.classList.add('connecting');
                btn.innerHTML = '<span>连接中...</span>';
                updateConnectionStatus('正在搜索设备...');

                // 请求设备（需要用户手势）
                const selectedDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: BLE_CONFIG.deviceName }],
                    optionalServices: [BLE_CONFIG.serviceUUID]
                });

                await connectToDevice(selectedDevice);

            } catch (error) {
                console.error('连接失败:', error);
                btn.classList.remove('connecting');
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/></svg> 连接设备';

                if (error.name !== 'NotFoundError') {
                    updateConnectionStatus('连接失败，请重试');
                } else {
                    updateConnectionStatus('未选择设备');
                }
            }
        }

        // 连接到指定设备（手动连接和自动重连共用）
        async function connectToDevice(targetDevice) {
            const btn = document.getElementById('connectBtn');
            btn.classList.add('connecting');
            btn.innerHTML = '<span>连接中...</span>';

            updateConnectionStatus('正在连接...');

            // 监听断开事件
            targetDevice.addEventListener('gattserverdisconnected', onDisconnected);

            // 连接 GATT 服务器
            const server = await targetDevice.gatt.connect();

            // 获取服务
            const service = await server.getPrimaryService(BLE_CONFIG.serviceUUID);

            // 获取特征值
            characteristic = await service.getCharacteristic(BLE_CONFIG.characteristicUUID);

            // 启动通知
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handleData);

            device = targetDevice;
            isConnected = true;
            updateConnectionStatus('已连接: ' + device.name);
            btn.classList.remove('connecting');
            btn.classList.add('connected');
            btn.innerHTML = '<span>断开连接</span>';

            // 记录本次会话开始索引
            sessionStartIndex = historyData.length;

            // 如果屏幕常亮已启用，请求 Wake Lock
            if (wakeLockEnabled) {
                await requestWakeLock();
            }
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            onDisconnected();
        }

        function onDisconnected() {
            isConnected = false;
            device = null;
            characteristic = null;

            // 重置会话统计
            sessionStartIndex = -1;

            // 释放 Wake Lock
            releaseWakeLock();

            const btn = document.getElementById('connectBtn');
            btn.classList.remove('connected', 'connecting');
            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.71 7.71L12 2l-5.71 5.71 1.42 1.41L11 5.83V14h2V5.83l3.29 3.29zM12 22l5.71-5.71-1.42-1.41L13 18.17V10h-2v8.17l-3.29-3.29-1.42 1.41z"/></svg> 连接设备';
            updateConnectionStatus('连接已断开');

            // 更新统计显示
            updateStats();
        }

        function handleData(event) {
            const value = event.target.value;
            const co2 = value.getUint16(0, true); // Little Endian

            // 添加到历史记录
            const record = {
                time: Date.now(),
                co2: co2
            };

            historyData.push(record);

            // 限制最大记录数
            if (historyData.length > MAX_HISTORY) {
                historyData = historyData.slice(-MAX_HISTORY);
                // 调整会话起始索引
                if (sessionStartIndex > 0) {
                    sessionStartIndex = Math.max(0, sessionStartIndex - 1);
                }
            }

            // 保存到 localStorage
            saveHistory();

            // 检测 CO2 超标报警
            if (alertEnabled && co2 > ALERT_THRESHOLD) {
                triggerAlert(co2);
            }

            // 更新 UI
            updateUI();
        }

        // ============ 数据存储 ============
        function loadHistory() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    historyData = JSON.parse(saved);
                }
            } catch (e) {
                console.error('加载历史数据失败:', e);
                historyData = [];
            }
        }

        function saveHistory() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
            } catch (e) {
                console.error('保存历史数据失败:', e);
                // 存储满了，删除一半旧数据
                if (e.name === 'QuotaExceededError') {
                    historyData = historyData.slice(-Math.floor(MAX_HISTORY / 2));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(historyData));
                }
            }
        }

        function clearHistory() {
            if (confirm('确定要清空所有历史数据吗？')) {
                historyData = [];
                localStorage.removeItem(STORAGE_KEY);
                updateUI();
            }
        }

        // ============ UI 更新 ============
        function updateUI() {
            updateCurrentValue();
            updateStats();
            updateChart();
            updateRecordCount();
        }

        function updateCurrentValue() {
            const valueEl = document.getElementById('co2Value');
            const indicatorEl = document.getElementById('statusIndicator');
            const textEl = document.getElementById('statusText');
            const descEl = document.getElementById('statusDesc');

            if (historyData.length === 0) {
                valueEl.textContent = '---';
                valueEl.className = 'co2-value color-good';
                indicatorEl.className = 'status-indicator bg-good';
                textEl.textContent = '等待连接';
                descEl.textContent = '请连接 CO2 传感器设备';
                return;
            }

            const latest = historyData[historyData.length - 1].co2;
            valueEl.textContent = latest;

            const quality = getAirQuality(latest);
            valueEl.className = 'co2-value color-' + quality.color;
            indicatorEl.className = 'status-indicator bg-' + quality.color;
            textEl.textContent = quality.text;
            descEl.textContent = quality.desc;
        }

        function updateStats() {
            const minEl = document.getElementById('statMin');
            const avgEl = document.getElementById('statAvg');
            const maxEl = document.getElementById('statMax');

            // 根据统计范围获取数据
            let dataToAnalyze;
            if (statsRange === 'session' && sessionStartIndex >= 0) {
                dataToAnalyze = historyData.slice(sessionStartIndex);
            } else {
                dataToAnalyze = historyData;
            }

            if (dataToAnalyze.length === 0) {
                minEl.textContent = '---';
                avgEl.textContent = '---';
                maxEl.textContent = '---';
                return;
            }

            const values = dataToAnalyze.map(d => d.co2);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const avg = Math.round(values.reduce((a, b) => a + b, 0) / values.length);

            minEl.textContent = min;
            avgEl.textContent = avg;
            maxEl.textContent = max;
        }

        function setStatsRange(range) {
            statsRange = range;
            // 更新标签样式
            document.querySelectorAll('.stats-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.range === range);
            });
            updateStats();
        }

        function updateRecordCount() {
            document.getElementById('recordCount').textContent = historyData.length;
        }

        function updateConnectionStatus(text) {
            document.getElementById('connectionStatus').textContent = text;
        }

        function getAirQuality(co2) {
            if (co2 <= AIR_QUALITY.good.max) {
                return AIR_QUALITY.good;
            } else if (co2 <= AIR_QUALITY.moderate.max) {
                return AIR_QUALITY.moderate;
            } else {
                return AIR_QUALITY.bad;
            }
        }

        // ============ 图表 ============
        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CO2 (ppm)',
                        data: [],
                        borderColor: '#4a90d9',
                        backgroundColor: 'rgba(74, 144, 217, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHitRadius: 10,
                        spanGaps: false // 遇到 null 时断开连线
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#252542',
                            titleColor: '#fff',
                            bodyColor: '#4a90d9',
                            borderColor: '#4a90d9',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#666'
                            },
                            suggestedMin: 400,
                            suggestedMax: 1200
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function updateChart() {
            if (!chart) return;

            // 根据时间范围过滤数据
            let filteredData;
            if (chartRange === 0) {
                filteredData = historyData;
            } else {
                const cutoff = Date.now() - chartRange * 60 * 1000;
                filteredData = historyData.filter(d => d.time >= cutoff);
            }

            const GAP_THRESHOLD = 30000; // 30秒无数据视为中断

            const labels = [];
            const values = [];

            filteredData.forEach((d, i) => {
                // 检测时间间隔，如果超过阈值则插入 null 断开连线
                if (i > 0) {
                    const gap = d.time - filteredData[i - 1].time;
                    if (gap > GAP_THRESHOLD) {
                        labels.push('');
                        values.push(null); // null 会让 Chart.js 断开连线
                    }
                }

                const date = new Date(d.time);
                labels.push(date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }));
                values.push(d.co2);
            });

            chart.data.labels = labels;
            chart.data.datasets[0].data = values;
            chart.update('none');
        }

        function setChartRange(minutes) {
            chartRange = minutes;
            // 更新按钮样式
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.minutes) === minutes);
            });
            updateChart();
        }

        // ============ 数据导出 ============
        function exportData() {
            if (historyData.length === 0) {
                alert('没有可导出的数据');
                return;
            }

            // 生成 CSV 内容
            let csv = 'Time,CO2 (ppm)\n';
            historyData.forEach(d => {
                const date = new Date(d.time);
                const timeStr = date.toLocaleString('zh-CN');
                csv += `"${timeStr}",${d.co2}\n`;
            });

            // 创建下载链接
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CO2_Data_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============ 屏幕常亮 ============
        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) {
                console.log('Wake Lock API 不支持');
                return;
            }

            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => {
                    console.log('Wake Lock 已释放');
                });
                console.log('Wake Lock 已激活');
            } catch (err) {
                console.log('Wake Lock 请求失败:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        async function toggleWakeLock() {
            wakeLockEnabled = !wakeLockEnabled;
            const btn = document.getElementById('wakeLockToggle');
            btn.classList.toggle('active', wakeLockEnabled);

            if (wakeLockEnabled && isConnected) {
                await requestWakeLock();
            } else {
                releaseWakeLock();
            }
        }

        // ============ CO2 超标报警 ============
        function toggleAlert() {
            alertEnabled = !alertEnabled;
            const btn = document.getElementById('alertToggle');
            btn.classList.toggle('active', alertEnabled);
        }

        function triggerAlert(co2) {
            const now = Date.now();

            // 防抖：冷却期内不重复报警
            if (now - lastAlertTime < ALERT_COOLDOWN) {
                return;
            }

            lastAlertTime = now;

            // 振动提醒
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }

            // 蜂鸣声
            playAlertSound();

            console.log('CO2 超标报警:', co2, 'ppm');
        }

        function playAlertSound() {
            try {
                // 创建或复用 AudioContext
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // 确保 AudioContext 处于运行状态
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 880; // A5 音符
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                // 第二声
                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();

                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);

                    osc2.frequency.value = 1100; // 更高的音
                    osc2.type = 'sine';

                    gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    osc2.start(audioContext.currentTime);
                    osc2.stop(audioContext.currentTime + 0.5);
                }, 300);

            } catch (err) {
                console.log('播放报警音失败:', err);
            }
        }
    </script>
</body>
</html>
